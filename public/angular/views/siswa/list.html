<!-- Siswa List View -->

<!-- Page Header -->
<div class="page-header">
    <div class="page-title">
        <i class="fas fa-users"></i>
        <div class="page-title-text">
            <h2>{{ pageTitle }}</h2>
            <p>Daftar semua data siswa yang terdaftar dalam sistem</p>
        </div>
    </div>
    <div class="page-actions">
        <button class="btn btn-success me-2" ng-click="downloadTemplate()">
            <i class="fas fa-download"></i> Download Template CSV
        </button>
        <button class="btn btn-info me-2" ng-click="showImportModal()">
            <i class="fas fa-file-import"></i> Import CSV
        </button>
        <a href="#!/siswa/create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Tambah Siswa Baru
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> Data Siswa
                </h5>
            </div>
            <div class="card-body">
                
                <!-- Filter Section -->
                <div class="filter-section mb-4" ng-if="!loading">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-filter"></i> Filter Berdasarkan Kelas
                            </label>
                            <select class="form-select" ng-model="filter.kelas_id" ng-change="applyFilter()">
                                <option value="">-- Semua Kelas --</option>
                                <option ng-repeat="kelas in kelasList" value="{{ kelas.id }}">
                                    {{ kelas.kelas }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-filter"></i> Filter Berdasarkan Jurusan
                            </label>
                            <select class="form-select" ng-model="filter.jurusan_id" ng-change="applyFilter()">
                                <option value="">-- Semua Jurusan --</option>
                                <option ng-repeat="jurusan in jurusanList" value="{{ jurusan.id }}">
                                    {{ jurusan.jurusan }} - {{ jurusan.bidang }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-secondary w-100" ng-click="resetFilter()" ng-if="filter.kelas_id || filter.jurusan_id">
                                <i class="fas fa-redo"></i> Reset Filter
                            </button>
                            <div class="alert alert-info mb-0 w-100" ng-if="!filter.kelas_id && !filter.jurusan_id" style="padding: 10px;">
                                <small><i class="fas fa-info-circle"></i> Menampilkan semua data</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div ng-if="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Memuat data siswa...</p>
                </div>
                
                <!-- Data Table -->
                <div ng-if="!loading" class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th width="5%">No</th>
                                <th>NIS</th>
                                <th>Nama Lengkap</th>
                                <th>Tempat Lahir</th>
                                <th>Tanggal Lahir</th>
                                <th>Jenis Kelamin</th>
                                <th>Kelas</th>
                                <th>Jurusan</th>
                                <th width="12%">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="siswa in filteredSiswas">
                                <td>{{ $index + 1 }}</td>
                                <td><strong>{{ siswa.nis }}</strong></td>
                                <td>{{ siswa.nama }}</td>
                                <td>{{ siswa.tempat }}</td>
                                <td>{{ siswa.tgl_lahir | date:'dd/MM/yyyy' }}</td>
                                <td>
                                    <span class="badge" ng-class="siswa.jenis_kelamin === 'L' ? 'bg-info' : 'bg-pink'">
                                        <i class="fas" ng-class="siswa.jenis_kelamin === 'L' ? 'fa-mars' : 'fa-venus'"></i>
                                        {{ siswa.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-success" ng-if="siswa.kelas">
                                        {{ siswa.kelas.kelas }}
                                    </span>
                                    <span class="text-muted" ng-if="!siswa.kelas">-</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning" ng-if="siswa.jurusan">
                                        {{ siswa.jurusan.jurusan }}
                                    </span>
                                    <span class="text-muted" ng-if="!siswa.jurusan">-</span>
                                </td>
                                <td class="table-actions">
                                    <a href="#!/siswa/edit/{{ siswa.id }}" class="btn btn-sm btn-warning" title="Edit Data">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button ng-click="deleteSiswa(siswa)" class="btn btn-sm btn-danger" title="Hapus Data">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr ng-if="filteredSiswas.length === 0 && siswas.length > 0">
                                <td colspan="9" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-search fa-2x mb-3 d-block"></i>
                                        <p class="mb-0">Tidak ada data siswa yang sesuai dengan filter</p>
                                        <button class="btn btn-secondary btn-sm mt-3" ng-click="resetFilter()">
                                            <i class="fas fa-redo"></i> Reset Filter
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr ng-if="siswas.length === 0">
                                <td colspan="9" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                                        <p class="mb-0">Belum ada data siswa yang terdaftar</p>
                                        <a href="#!/siswa/create" class="btn btn-primary btn-sm mt-3">
                                            <i class="fas fa-plus"></i> Tambah Siswa Pertama
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Total Data -->
                <div ng-if="!loading && siswas.length > 0" class="mt-3">
                    <div class="alert alert-info border-0 mb-0" style="background: #E1F5FE;">
                        <i class="fas fa-info-circle" style="color: #0277BD;"></i>
                        <small style="color: #01579B;">
                            <span ng-if="!filter.kelas_id && !filter.jurusan_id">
                                Total: <strong>{{ siswas.length }}</strong> siswa terdaftar
                            </span>
                            <span ng-if="filter.kelas_id || filter.jurusan_id">
                                Menampilkan: <strong>{{ filteredSiswas.length }}</strong> dari <strong>{{ siswas.length }}</strong> siswa
                            </span>
                        </small>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="fas fa-file-import"></i> Import Data Siswa dari CSV
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <!-- Instructions -->
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> Panduan Import:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Download template CSV terlebih dahulu</li>
                        <li>Isi data siswa sesuai format yang ada</li>
                        <li>Pastikan kelas dan jurusan sudah terdaftar di sistem</li>
                        <li>NIS harus unique (tidak boleh duplikat)</li>
                        <li>Jenis kelamin: L (Laki-laki) atau P (Perempuan)</li>
                        <li>Format tanggal: YYYY-MM-DD (contoh: 2005-01-15)</li>
                        <li>File CSV bisa menggunakan delimiter koma (,) atau titik koma (;)</li>
                    </ul>
                </div>
                
                <!-- File Upload -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-file-csv"></i> Pilih File CSV
                    </label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv" 
                           onchange="angular.element(this).scope().handleFileSelect(this)" />
                    <small class="text-muted">
                        File maksimal 2MB. Format: .csv
                    </small>
                </div>
                
                <!-- Upload Progress -->
                <div ng-if="uploadProgress.uploading" class="mb-3">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 100%">
                            Sedang mengupload...
                        </div>
                    </div>
                </div>
                
                <!-- Import Result -->
                <div ng-if="importResult" class="mt-3">
                    <div class="alert" ng-class="importResult.failed_count > 0 ? 'alert-warning' : 'alert-success'">
                        <h6 class="alert-heading">
                            <i class="fas" ng-class="importResult.failed_count > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'"></i>
                            Hasil Import
                        </h6>
                        <hr>
                        <p class="mb-1">
                            <strong>Berhasil:</strong> {{ importResult.success_count }} siswa<br>
                            <strong>Gagal:</strong> {{ importResult.failed_count }} siswa
                        </p>
                        
                        <!-- Download Failed Records -->
                        <button ng-if="importResult.failed_count > 0" 
                                class="btn btn-sm btn-danger mt-2" 
                                ng-click="downloadFailedRecords()">
                            <i class="fas fa-download"></i> Download Data yang Gagal
                        </button>
                        
                        <!-- Failed Records Table -->
                        <div ng-if="importResult.failed_count > 0" class="mt-3" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Baris</th>
                                        <th>NIS</th>
                                        <th>Nama</th>
                                        <th>Kelas</th>
                                        <th>Jurusan</th>
                                        <th>Keterangan Error</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="record in importResult.failed_records">
                                        <td>{{ record.row }}</td>
                                        <td>{{ record.nis }}</td>
                                        <td>{{ record.nama }}</td>
                                        <td>{{ record.kelas }}</td>
                                        <td>{{ record.jurusan }}</td>
                                        <td><small class="text-danger">{{ record.errors }}</small></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button type="button" class="btn btn-primary" ng-click="uploadCSV()" 
                        ng-disabled="!selectedFile || uploadProgress.uploading">
                    <i class="fas fa-upload"></i> Upload & Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<style>
.filter-section {
    background: #F5F5F5;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #E0E0E0;
}

.filter-section .form-label {
    color: #546E7A;
    font-size: 13px;
    margin-bottom: 8px;
}

.filter-section .form-label i {
    color: #4FC3F7;
}
</style>

<!-- Custom CSS untuk badge pink -->
<style>
.bg-pink {
    background-color: #EC407A !important;
}
</style>
